<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Joe's Financial Manager</title>
<link rel="icon" type="image/svg+xml" href="assets/wallet.svg" />

<link rel="icon" type="image/svg+xml" href="assets/wallet.svg" />
<link rel="alternate icon" type="image/png" href="assets/wallet.svg" />

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="css/styles.css?v=1.9" />

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" defer onerror="loadChartFallback()"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js" defer onerror="loadJSPDFFallback()"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js" defer></script>
  
  <!-- Chart.js Fallback -->
  <script>
    function loadChartFallback() {
      console.log('Chart.js CDN failed, trying alternative CDN...');
      const script = document.createElement('script');
      script.src = 'https://unpkg.com/chart.js@4.4.1/dist/chart.umd.min.js';
      script.defer = true;
      script.onerror = function() {
        console.error('All Chart.js CDNs failed. Charts will not render.');
        document.body.insertAdjacentHTML('beforeend', 
          '<div id="chart-error" style="position:fixed;top:10px;right:10px;background:#ff6b6b;color:white;padding:10px;border-radius:5px;z-index:9999;">‚ö†Ô∏è Charts unavailable offline</div>'
        );
      };
      document.head.appendChild(script);
    }
    
    function loadJSPDFFallback() {
      console.log('jsPDF CDN failed, trying alternative CDN...');
      const script = document.createElement('script');
      script.src = 'https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js';
      script.defer = true;
      script.onerror = function() {
        console.error('All jsPDF CDNs failed. PDF generation will not work.');
        document.body.insertAdjacentHTML('beforeend', 
          '<div id="pdf-error" style="position:fixed;top:50px;right:10px;background:#ff6b6b;color:white;padding:10px;border-radius:5px;z-index:9999;">‚ö†Ô∏è PDF generation unavailable offline</div>'
        );
      };
      document.head.appendChild(script);
    }
  </script>

  <!-- App Modules -->
  <script src="js/database.js" defer></script>
  <script src="js/state.js" defer></script>
  <script src="js/utils.js" defer></script>
  <script src="js/validation.js" defer></script>
  <script src="js/charts.js" defer></script>
  <script src="js/pdf.js" defer></script>
  <script src="js/excel.js" defer></script>
    <script src="js/ui.js?v=2.5" defer></script>
  <script src="js/router.js" defer></script>
  <script src="js/app.js" defer></script>
</head>
<body>
  <header class="app-header">
    <div class="brand">
      <img src="assets/wallet.svg" class="logo" alt="logo" />
      <h1>Joe's Financial Manager <span class="tag">V5</span></h1>
    </div>
    <nav class="top-nav" id="topNav">
      <a href="#/dashboard" class="nav-item" data-route="dashboard">Dashboard</a>
      <a href="#/accounts" class="nav-item" data-route="accounts">Accounts</a>
      <a href="#/transactions" class="nav-item" data-route="transactions">Transactions</a>
      <a href="#/budget" class="nav-item" data-route="budget">Budget</a>
      <a href="#/categories" class="nav-item" data-route="categories">Categories</a>
      <a href="#/overview" class="nav-item" data-route="overview">Account Overview</a>
      <a href="#/networth" class="nav-item" data-route="networth">Net Worth</a>
      <a href="#/reports" class="nav-item" data-route="reports">Reports</a>
      <a href="#/settings" class="nav-item" data-route="settings">Settings</a>
    </nav>
  </header>

  <div id="cdnWarning" class="cdn-warning hidden"></div>
  <main id="app" class="app-container container"></main>

  <footer class="mobile-tabbar">
    <a href="#/dashboard" data-route="dashboard">üè†<span>Dashboard</span></a>
    <a href="#/accounts" data-route="accounts">üè¶<span>Accounts</span></a>
    <a href="#/transactions" data-route="transactions">üßæ<span>Transactions</span></a>
    <a href="#/budget" data-route="budget">üìä<span>Budget</span></a>
    <a href="#/settings" data-route="settings">‚öôÔ∏è<span>Settings</span></a>
  </footer>

  <!-- TEMPLATES -->

  <template id="tpl-dashboard">
    <section class="section">
      <div class="row-between">
        <h2>Dashboard</h2>
        <div class="row gap-sm">
          <label class="inline">Start <input type="date" id="dashStart" class="date"></label>
          <label class="inline">End <input type="date" id="dashEnd" class="date"></label>
          <button class="btn" id="dashApply">Apply</button>
        </div>
      </div>
      
      <!-- Financial Overview Layout -->
      <div class="dashboard-overview mb-lg">
        <!-- Left: Financial Statements -->
        <div class="financial-statements">
          <div class="card dashboard-card financial-card">
            <h3 class="dashboard-heading financial-heading">üìä P&L Statement (USD)</h3>
            <div class="financial-metrics">
              <div class="financial-metric">
                <div class="metric-label">Income</div>
                <div id="plIncome" class="metric-value metric-income">‚Äî</div>
              </div>
              <div class="financial-metric">
                <div class="metric-label">Expenses</div>
                <div id="plExpenses" class="metric-value metric-expense">‚Äî</div>
              </div>
              <div class="financial-metric financial-total">
                <div class="metric-label">Net P&L</div>
                <div id="plNet" class="metric-value metric-net">‚Äî</div>
              </div>
            </div>
            <div class="financial-note">
              üí° All income/expenses regardless of payment method
            </div>
          </div>
          
          <div class="card dashboard-card financial-card">
            <h3 class="dashboard-heading financial-heading">üí∞ Cash Flow (USD)</h3>
            <div class="financial-metrics">
              <div class="financial-metric">
                <div class="metric-label">Cash In</div>
                <div id="cfIn" class="metric-value metric-income">‚Äî</div>
              </div>
              <div class="financial-metric">
                <div class="metric-label">Cash Out</div>
                <div id="cfOut" class="metric-value metric-expense">‚Äî</div>
              </div>
              <div class="financial-metric financial-total">
                <div class="metric-label">Net Cash</div>
                <div id="cfNet" class="metric-value metric-net">‚Äî</div>
              </div>
            </div>
            <div class="financial-note">
              üí° Actual cash movements only (no credit purchases)
            </div>
          </div>
        </div>
        
        <!-- Center: Key Insights (Vertical Stack) -->
        <div class="insights-section">
          <div class="card insight-card insight-compact">
            <div class="insight-label">Largest Expense (USD)</div>
            <div id="kpiLargestExp" class="insight-value">‚Äî</div>
          </div>
          <div class="card insight-card insight-compact">
            <div class="insight-label">Top Category (USD)</div>
            <div id="kpiTopCat" class="insight-value">‚Äî</div>
          </div>
          <div class="card insight-card insight-compact">
            <div class="insight-label">Avg Daily Spend (USD)</div>
            <div id="kpiAvgDaily" class="insight-value">‚Äî</div>
          </div>
          <div class="card insight-card insight-compact">
            <div class="insight-label">Transaction Count</div>
            <div id="kpiTxnCount" class="insight-value">‚Äî</div>
          </div>
        </div>
        
        <!-- Right: Cash Flow Chart -->
        <div class="chart-section">
          <div class="card dashboard-card chart-card">
            <h3 class="dashboard-heading">üìà Cash Flow Trend (USD)</h3>
            <canvas id="chartCashFlow" height="200"></canvas>
          </div>
        </div>
      </div>
      
      <!-- Charts -->
      <div class="grid-2 mb-lg">
        <div class="card dashboard-card">
          <h3 class="dashboard-heading">Spending by Category (USD)</h3>
          <canvas id="chartSpendCat" height="200"></canvas>
        </div>
        <div class="card dashboard-card">
          <h3 class="dashboard-heading">Income by Category (USD)</h3>
          <canvas id="chartIncomeCat" height="200"></canvas>
        </div>
      </div>
      
      <!-- Additional Insights -->
      <div class="grid-2">
        <div class="card dashboard-card">
          <h3 class="dashboard-heading">Unusual Transactions (USD)</h3>
          <div class="small muted mb-sm">Transactions ‚â• 3√ó category average</div>
          <ul id="unusualList" class="list"></ul>
        </div>
        <div class="card dashboard-card">
          <h3 class="dashboard-heading">Upcoming Payments (USD)</h3>
          <div class="small muted mb-sm">Next 30 days</div>
          <ul id="upcomingPayments30" class="list"></ul>
        </div>
      </div>
    </section>
  </template>

  <template id="tpl-accounts">
    <section class="section">
      <div class="title-row"><h2>Accounts</h2><button class="btn primary" id="btnAddAccount">Add Account</button></div>
      <div id="accountsList" class="list list-cards"></div>
      <dialog id="dlgAccount">
        <form method="dialog" id="formAccount" class="form">
          <h3 id="accountFormTitle">Add Account</h3>
          <input type="hidden" id="accId" />
          <label>Name <input required id="accName"/></label>
          <label>Type
            <select id="accType" required class="select">
              <option value="checking">Checking</option>
              <option value="savings">Savings</option>
              <option value="credit-card">Credit Card</option>
              <option value="cash">Cash</option>
            </select>
          </label>
          <label>Currency
            <select id="accCurrency" required class="select">
              <option value="USD">USD</option>
              <option value="MXN">MXN</option>
            </select>
          </label>
          <label>Country
            <select id="accCountry" required class="select">
              <option value="USA">USA</option>
              <option value="Mexico">Mexico</option>
            </select>
          </label>
          <div class="grid-2">
            <label>Balance As Of Amount <input type="number" step="0.01" id="accAsOfAmt" value="0" class="input"/></label>
            <label>As Of Date <input type="date" id="accAsOfDate" class="date" /></label>
          </div>
          <label class="credit-only">Credit Limit (required for credit cards) <input type="number" step="0.01" id="accCreditLimit" value="0" class="input"/></label>
          <label class="credit-only">Next Closing Date <input type="date" id="accNextClosing" class="date" /></label>
          <label class="credit-only">Payment Due Day (1‚Äì28)<input type="number" min="1" max="28" id="accDueDay" placeholder="15" class="input" /></label>
          <label class="credit-only">Minimum Payment Due <input type="number" step="0.01" id="accMinDue" value="0" class="input"/></label>
          <menu class="dialog-actions">
            <button type="submit" class="btn primary">Save</button>
            <button type="button" class="btn" id="btnCloseAccount">Cancel</button>
          </menu>
        </form>
      </dialog>
    </section>
  </template>

  <template id="tpl-categories">
    <section class="section">
      <div class="title-row">
        <h2>üìÇ Categories</h2>
        <div class="row gap-sm">
          <button class="btn primary" id="btnAddCategory">‚ûï Add Category</button>
          <button class="btn" id="btnAddSubcategory">‚ûï Add Subcategory</button>
        </div>
      </div>
      
      <div class="grid-2">
        <div class="card">
          <div class="card-header">
            <h3>üí∏ Expense Categories</h3>
            <span class="badge" id="expenseCount">0</span>
          </div>
          <div class="category-tree" id="expenseCats"></div>
        </div>
        <div class="card">
          <div class="card-header">
            <h3>üí∞ Income Categories</h3>
            <span class="badge" id="incomeCount">0</span>
          </div>
          <div class="category-tree" id="incomeCats"></div>
        </div>
      </div>
      
      <dialog id="dlgCategory">
        <form method="dialog" id="formCategory" class="form">
          <h3 id="catFormTitle">‚ûï Add Category</h3>
          <input type="hidden" id="catId"/>
          
          <div class="form-row">
            <label>Name <input required id="catName" placeholder="e.g., Food & Dining"/></label>
            <label>Type
              <select id="catType" required>
                <option value="expense">üí∏ Expense</option>
                <option value="income">üí∞ Income</option>
              </select>
            </label>
          </div>
          
          <label>Parent Category (optional)
            <select id="catParent">
              <option value="">‚Äî Create as main category ‚Äî</option>
            </select>
          </label>
          
          <div class="form-help">
            <p class="small muted">üí° <strong>Tip:</strong> Create main categories first, then add subcategories for better organization.</p>
          </div>
          
          <menu class="dialog-actions">
            <button type="submit" class="btn primary">üíæ Save Category</button>
            <button type="button" class="btn" id="btnCloseCategory">‚ùå Cancel</button>
          </menu>
        </form>
      </dialog>
    </section>
  </template>

  <template id="tpl-budget">
    <section class="section">
      <div class="title-row">
        <h2>Budget</h2>
      </div>

      <!-- Create Budget Series -->
      <div class="card budget-form-card">
        <h3>Create Budget Series</h3>
        <div class="budget-form-grid">
          <div class="form-group">
            <label class="form-label">Type</label>
            <select id="bType" class="form-select">
              <option value="expense">Expense</option>
              <option value="income">Income</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Category</label>
            <select id="bCategory" class="form-select"></select>
          </div>
          <div class="form-group">
            <label class="form-label">Currency</label>
            <select id="bCurrency" class="form-select">
              <option value="USD">USD</option>
              <option value="MXN">MXN</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Amount</label>
            <input id="bAmount" type="number" step="0.01" min="0" class="form-input">
          </div>
          <div class="form-group" id="bFxGroup" style="display: none;">
            <label class="form-label">FX Rate (USD per MXN)</label>
            <input id="bFxRate" type="number" step="0.0001" min="0" class="form-input" placeholder="Auto-filled">
          </div>
          <div class="form-group">
            <label class="form-label">Cadence</label>
            <select id="bCadence" class="form-select">
              <option value="monthly">Monthly</option>
              <option value="biweekly">Bi-Weekly</option>
              <option value="weekly">Weekly</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Anchor Date</label>
            <input id="bAnchor" type="date" class="form-input">
          </div>
          <div class="form-group">
            <label class="form-label">Repeat Until (Optional)</label>
            <input id="bUntil" type="date" placeholder="leave empty = forever" class="form-input">
          </div>
        </div>
        <div class="budget-form-actions">
          <button class="btn primary" id="btnBudgetSeriesSave">Save Series</button>
          <button class="btn" id="btnBudgetSeriesReset" type="button">Clear</button>
        </div>
      </div>

      <!-- Overall Budget Summary -->
      <div class="card budget-summary">
        <div class="budget-summary-header">
          <h3>Budget Summary</h3>
          <div class="month-selector">
            <button class="btn-month" id="budgetPrevMonth">‚Äπ</button>
            <span id="budgetMonthYear" class="month-display">Sep 2025</span>
            <button class="btn-month" id="budgetNextMonth">‚Ä∫</button>
          </div>
        </div>
        <div class="budget-overview-compact">
          <div class="budget-stats-grid">
            <div class="budget-stat-compact">
              <div class="stat-label-compact">Income</div>
              <div class="stat-values-compact">
                <div class="stat-line">
                  <span class="stat-type">Budget:</span>
                  <span id="budgetBudgetedIncome" class="stat-amount">$0.00</span>
                </div>
                <div class="stat-line">
                  <span class="stat-type">Actual:</span>
                  <span id="budgetActualIncome" class="stat-amount">$0.00</span>
                </div>
                <div class="stat-line">
                  <span class="stat-type">Diff:</span>
                  <span id="incomeVariance" class="variance-amount">$0.00</span>
                </div>
              </div>
            </div>
            <div class="budget-stat-compact">
              <div class="stat-label-compact">Expenses</div>
              <div class="stat-values-compact">
                <div class="stat-line">
                  <span class="stat-type">Budget:</span>
                  <span id="budgetBudgetedExpenses" class="stat-amount">$0.00</span>
                </div>
                <div class="stat-line">
                  <span class="stat-type">Actual:</span>
                  <span id="budgetActualExpenses" class="stat-amount">$0.00</span>
                </div>
                <div class="stat-line">
                  <span class="stat-type">Diff:</span>
                  <span id="expenseVariance" class="variance-amount">$0.00</span>
                </div>
              </div>
            </div>
            <div class="budget-stat-compact">
              <div class="stat-label-compact">Net</div>
              <div class="stat-values-compact">
                <div class="stat-line">
                  <span class="stat-type">Budget:</span>
                  <span id="budgetNetBudgeted" class="stat-amount">$0.00</span>
                </div>
                <div class="stat-line">
                  <span class="stat-type">Actual:</span>
                  <span id="budgetNetActual" class="stat-amount">$0.00</span>
                </div>
                <div class="stat-line">
                  <span class="stat-type">Diff:</span>
                  <span id="netVariance" class="variance-amount">$0.00</span>
                </div>
              </div>
            </div>
          </div>
          <div class="budget-progress-compact">
            <div class="progress-header-compact">
              <span class="progress-title">Monthly Budget Progress</span>
              <span id="budgetPercentage" class="progress-percentage">0%</span>
            </div>
            <div class="progress-bar-compact">
              <div class="progress-fill-compact" id="budgetBarFill" style="width: 0%"></div>
            </div>
            <div class="progress-details-compact">
              <span class="progress-budget">Budget: <span id="budgetTotalAmount">$0.00</span></span>
              <span class="progress-spent">Spent: <span id="budgetSpentAmount">$0.00</span></span>
              <span class="progress-remaining">Remaining: <span id="budgetRemainingAmount">$0.00</span></span>
            </div>
          </div>
        </div>
      </div>

      <!-- Diverging Budget Chart -->
      <div class="card">
        <h3>Budget vs Actual by Category</h3>
        <div class="diverging-chart-container">
          <canvas id="divergingChart" height="400"></canvas>
        </div>
        <div class="chart-legend">
          <div class="legend-item">
            <div class="legend-color budget-color"></div>
            <span>Budget</span>
          </div>
          <div class="legend-item">
            <div class="legend-color actual-color"></div>
            <span>Actual</span>
          </div>
        </div>
      </div>

      <div class="grid-2 mt-sm">
        <div class="card">
          <h3 style="color: #ffffff !important; text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8) !important; font-weight: 800 !important;">My Budget Series</h3>
          <table id="tblSeries" class="table">
            <thead><tr>
              <th>Type</th><th>Category</th><th>Cadence</th><th>Amount</th><th>Anchor</th><th>Until</th><th>Actions</th>
            </tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="card">
          <div class="row" style="justify-content:space-between;align-items:center;">
            <h3 style="color: #ffffff !important; text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8) !important; font-weight: 800 !important;">Monthly Budget vs Actual</h3>
            <label class="muted">Month
              <input id="bMonth" type="month">
            </label>
          </div>
          <div id="budgetTableContainer">
            <div class="budget-section">
              <h4>Income Categories</h4>
              <table id="tblBVAIncome" class="table">
                <thead><tr>
                  <th>Category</th><th>Budget</th><th>Actual</th><th>Variance</th>
                </tr></thead>
                <tbody></tbody>
                <tfoot><tr>
                  <th>Total Income</th><th id="bvaIncomeBudTot"></th><th id="bvaIncomeActTot"></th><th id="bvaIncomeVarTot"></th>
                </tr></tfoot>
              </table>
            </div>
            <div class="budget-section">
              <h4>Expense Categories</h4>
              <table id="tblBVAExpense" class="table">
                <thead><tr>
                  <th>Category</th><th>Budget</th><th>Actual</th><th>Variance</th>
                </tr></thead>
                <tbody></tbody>
                <tfoot><tr>
                  <th>Total Expenses</th><th id="bvaExpenseBudTot"></th><th id="bvaExpenseActTot"></th><th id="bvaExpenseVarTot"></th>
                </tr></tfoot>
              </table>
            </div>
          </div>
        </div>
      </div>
    </section>
  </template>

  <template id="tpl-transactions">
    <section class="section">
      <div class="title-row">
        <h2>Transactions</h2>
        <div class="row gap-sm">
          <button class="btn small" type="button" id="btnAddMultiple">üí∞ Bulk Add</button>
        </div>
      </div>
      
      <!-- Mobile-First Layout: Compact Form + Transaction Log -->
      <div class="transaction-layout">
        <!-- Left Side: Compact Entry Form -->
        <div class="transaction-form-card">
          <div class="form-header">
            <h3>Quick Add</h3>
            <div class="form-status">
              <span class="status-indicator" id="formStatus">Ready</span>
            </div>
          </div>
          
          <form id="formTxn" class="transaction-form">
            <input type="hidden" id="txnId" />
            
            <!-- Row 1: Date & Type -->
            <div class="form-row-compact">
              <label class="compact">
                <span>Date</span>
                <input type="date" id="txnDate" required />
              </label>
              <label class="compact">
                <span>Type</span>
                <select id="txnType">
                  <option value="Expense">üí∏ Expense</option>
                  <option value="Income">üí∞ Income</option>
                  <option value="Transfer">üîÑ Transfer</option>
                  <option value="Credit Card Payment">üí≥ CC Payment</option>
                </select>
              </label>
            </div>
            
            <!-- Row 2: Amount & Currency -->
            <div class="form-row-compact">
              <label class="compact">
                <span>Amount</span>
                <input type="number" id="txnAmount" step="0.01" required placeholder="0.00" />
              </label>
              <label class="compact">
                <span>Currency</span>
                <select id="txnCurrency">
                  <option value="USD">üá∫üá∏ USD</option>
                  <option value="MXN">üá≤üáΩ MXN</option>
                </select>
              </label>
            </div>
            
            <!-- Row 3: FX Rate (when needed) -->
            <div class="form-row-compact fx-row" id="fxRow" style="display:none;">
              <label class="compact">
                <span>FX Rate</span>
                <input type="number" id="txnFx" step="0.0001" placeholder="Auto" />
              </label>
              <div class="fx-info">
                <span class="small muted">USD per MXN</span>
              </div>
            </div>
            
            <!-- Row 4: From & To -->
            <div class="form-row-compact">
              <label class="compact" id="lblFromAcc">
                <span>From</span>
                <select id="txnFromAccount"></select>
              </label>
              <label class="compact" id="lblToAcc">
                <span>To</span>
                <select id="txnToAccount"></select>
              </label>
            </div>
            
            <!-- Row 5: Description -->
            <div class="form-row-full">
              <label class="compact">
                <span>Description</span>
                <input id="txnDesc" placeholder="e.g., Groceries, Salary..." />
              </label>
            </div>
            
            <!-- Credit Card Deferred Payment Fields -->
            <div id="deferredFields" class="deferred-section" style="display:none;">
              <div class="deferred-header">
                <label class="checkbox-compact">
                  <input type="checkbox" id="txnIsDeferred" />
                  <span>üí≥ Installments</span>
                </label>
              </div>
              <div id="deferredMonthsRow" class="form-row-compact" style="display:none;">
                <label class="compact" id="lblDeferredMonths">
                  <span>Months</span>
                  <input type="number" id="txnDeferredMonths" min="1" max="60" value="1" />
                </label>
                <div class="monthly-payment">
                  <span class="small">Monthly: <strong id="monthlyPaymentAmount">$0.00</strong></span>
                </div>
              </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="form-actions">
              <button class="btn primary compact" type="submit" id="txnSubmit">
                <span class="btn-icon">‚ûï</span>
                <span class="btn-text">Add</span>
              </button>
              <button class="btn compact" type="button" id="btnCancelEdit">
                <span class="btn-icon">‚ùå</span>
                <span class="btn-text">Cancel</span>
              </button>
            </div>
            
            <div class="form-help">
              <span class="muted small">üí° Categories are hierarchical</span>
            </div>
          </form>
        </div>
        
        <!-- Right Side: Transaction Log -->
        <div class="transaction-log-card">
          <div class="log-header">
            <h3>Transaction History</h3>
            <div class="log-controls">
              <button class="btn small" id="btnToggleFilters">üîç</button>
              <button class="btn small" id="btnRefreshLog">üîÑ</button>
            </div>
          </div>
          
          <!-- Bulk Actions Toolbar -->
          <div class="bulk-actions-toolbar" id="bulkActionsToolbar" style="display: none;">
            <div class="bulk-selection-info">
              <span id="bulkSelectionCount">0 transactions selected</span>
            </div>
        <div class="bulk-action-buttons">
          <button class="btn small" id="btnSelectAll">‚úÖ Select All</button>
          <button class="btn small" id="btnSelectNone">‚ùå Clear</button>
          <button class="btn small danger" id="btnBulkDelete">üóëÔ∏è Delete</button>
          <button class="btn small" id="btnBulkExport">üì§ Export</button>
          <button class="btn small" id="btnCloseBulkActions">‚úñÔ∏è Close</button>
        </div>
          </div>
          
          <!-- Collapsible Filters -->
          <div class="filters-section" id="filtersSection" style="display:none;">
            <div class="filters-compact">
              <div class="filter-row">
                <input id="filterText" type="search" placeholder="üîç Search..." />
                <select id="filterType">
                  <option value="">All Types</option>
                  <option value="Expense">üí∏ Expense</option>
                  <option value="Income">üí∞ Income</option>
                  <option value="Transfer">üîÑ Transfer</option>
                  <option value="Credit Card Payment">üí≥ CC Payment</option>
                </select>
              </div>
              <div class="filter-row">
                <input type="date" id="filterStart" placeholder="From" title="From date" />
                <input type="date" id="filterEnd" placeholder="To" title="To date" />
              </div>
              <div class="filter-row">
                <input id="filterAmountMin" type="number" step="0.01" placeholder="Min $" />
                <input id="filterAmountMax" type="number" step="0.01" placeholder="Max $" />
              </div>
              <div class="filter-row">
                <select id="filterAccount"></select>
                <select id="filterCategory"></select>
              </div>
              <div class="filter-actions">
                <button class="btn small" id="btnClearFilters">Clear</button>
              </div>
            </div>
          </div>
          
          <!-- Sort Controls -->
          <div class="sort-controls">
            <span class="sort-label">Sort:</span>
            <button class="btn small" id="txnSortDate">üìÖ Date</button>
            <button class="btn small" id="txnSortAmount">üí∞ Amount</button>
            <button class="btn small" id="txnSortDescription">üìù Name</button>
          </div>
          
          <!-- Transaction List -->
          <div id="txTable" class="transaction-table">
            <div id="txTableBody" class="transaction-list-body"></div>
          </div>
        </div>
      </div>
    </section>
  </template>
      <dialog id="dlgTxnBulk" class="bulk-grid-dialog">
        <form id="formTxnBulk" class="bulk-grid-form">
          <div class="bulk-header">
            <h3>üìã Bulk Add Transactions</h3>
            <p class="bulk-help">üí° <strong>Tips:</strong> Use Tab/Enter to navigate ‚Ä¢ Ctrl+B to open bulk mode ‚Ä¢ Rows auto-add when typing ‚Ä¢ Green=valid, Yellow=partial, Red=incomplete</p>
          </div>
          
          <div class="bulk-grid-container">
            <table id="bulkGrid" class="bulk-grid">
              <thead>
                <tr>
                  <th width="120">Date</th>
                  <th width="100">Type</th>
                  <th width="90">Amount</th>
                  <th width="70">Currency</th>
                  <th width="130">From Account</th>
                  <th width="130">To Account/Category</th>
                  <th width="180">Description</th>
                  <th width="80">FX Rate</th>
                  <th width="100">Installments</th>
                  <th width="40">Actions</th>
                </tr>
              </thead>
              <tbody id="bulkGridBody">
                <!-- Rows will be generated by JavaScript -->
              </tbody>
            </table>
          </div>
          
          <div class="bulk-actions">
            <div class="bulk-actions-left">
              <button type="button" class="btn small" id="btnAddRow">‚ûï Add Row</button>
              <button type="button" class="btn small" id="btnAddRows">‚ûï Add 5 Rows</button>
              <button type="button" class="btn small muted" id="btnClearAll">üóëÔ∏è Clear All</button>
            </div>
            <div class="bulk-actions-right">
              <span class="bulk-count">0 transactions ready</span>
            </div>
          </div>
          
          <menu class="dialog-actions">
            <button type="submit" class="btn primary" id="btnBulkSave">üíæ Save All Transactions</button>
            <button type="button" class="btn" id="btnBulkClose">Cancel</button>
          </menu>
        </form>
      </dialog>
    </section>
  </template>

  <template id="tpl-overview">
    <section class="section">
      <div class="title-row">
        <h2>Account Overview</h2>
        <div class="row gap-sm">
          <label class="inline">Country
            <select id="ovCountry"><option value="">All</option><option value="USA">USA</option><option value="Mexico">Mexico</option></select>
          </label>
        </div>
      </div>
      <div class="kpis grid-5">
        <div class="card kpi"><div class="kpi-title">Total Cash & Bank (USD)</div><div id="ovCash" class="kpi-value">‚Äî</div></div>
        <div class="card kpi"><div class="kpi-title">Total Credit Card Debt (USD)</div><div id="ovDebt" class="kpi-value">‚Äî</div></div>
        <div class="card kpi"><div class="kpi-title">Total Credit Limit (USD)</div><div id="ovLimit" class="kpi-value">‚Äî</div></div>
        <div class="card kpi"><div class="kpi-title">Utilization</div><div id="ovUtil" class="kpi-value">‚Äî</div></div>
        <div class="card kpi"><div class="kpi-title">Upcoming Payments (30d)</div><div id="ovUpcoming" class="kpi-value">‚Äî</div></div>
      </div>
      <div class="grid-2">
        <div class="card"><h3>Due Dates Calendar (Current & Next Month)</h3><div id="dueCalendar" class="calendar"></div><div id="dueList" class="list mt-sm"></div></div>
        <div class="card"><h3>Cards & Utilization</h3><div id="cardList"></div></div>
      </div>
    </section>
  </template>

  <template id="tpl-networth">
    <section class="section">
      <h2>Net Worth</h2>
      
      <!-- Main Net Worth Card -->
      <div class="card">
        <div class="grid-2 stack-mobile">
          <div>
            <div class="kpi">
              <div class="kpi-title">Current Net Worth (USD)</div>
              <div id="nwNow" class="kpi-value">‚Äî</div>
            </div>
            <div class="insight-list">
              <div><strong>Change vs last month:</strong> <span id="nwChange">‚Äî</span> <span id="nwChangePercent" class="small"></span></div>
              <div><strong>Monthly Growth:</strong> <span id="nwMonthlyGrowth">‚Äî</span></div>
              <div><strong>Yearly Growth:</strong> <span id="nwYearlyGrowth">‚Äî</span></div>
              <div><strong>Trend:</strong> <span id="nwTrend" class="badge">‚Äî</span></div>
            </div>
            <button class="btn" id="btnSnapshot">Snapshot Now</button>
            <button class="btn secondary" id="btnExportNetWorth">Export Data</button>
          </div>
          <div><canvas id="chartNetWorth" height="220"></canvas></div>
        </div>
      </div>

      <!-- Assets & Liabilities Breakdown -->
      <div class="grid-2">
        <div class="card">
          <h3>Assets Breakdown</h3>
          <div class="kpi">
            <div class="kpi-title">Total Assets</div>
            <div id="nwTotalAssets" class="kpi-value good">‚Äî</div>
          </div>
          <div id="nwAssetsList" class="account-list"></div>
        </div>
        
        <div class="card">
          <h3>Liabilities Breakdown</h3>
          <div class="kpi">
            <div class="kpi-title">Total Liabilities</div>
            <div id="nwTotalLiabilities" class="kpi-value bad">‚Äî</div>
          </div>
          <div id="nwLiabilitiesList" class="account-list"></div>
        </div>
      </div>

      <!-- Financial Health Metrics -->
      <div class="card">
        <h3>Financial Health Metrics</h3>
        <div class="grid-3">
          <div class="metric">
            <div class="metric-title">Debt-to-Asset Ratio</div>
            <div id="nwRatio" class="metric-value">‚Äî</div>
            <div class="metric-desc">Lower is better (aim for &lt;30%)</div>
          </div>
          <div class="metric">
            <div class="metric-title">Largest Asset</div>
            <div id="nwAsset" class="metric-value">‚Äî</div>
            <div class="metric-desc">Your biggest financial position</div>
          </div>
          <div class="metric">
            <div class="metric-title">Largest Liability</div>
            <div id="nwLiability" class="metric-value">‚Äî</div>
            <div class="metric-desc">Your biggest financial obligation</div>
          </div>
        </div>
      </div>

      <!-- Asset Allocation Chart -->
      <div class="card">
        <h3>Asset Allocation</h3>
        <div style="max-width: 400px; margin: 0 auto;">
          <canvas id="chartAssetAllocation" height="250"></canvas>
        </div>
      </div>
    </section>
  </template>

    <template id="tpl-reports">
      <section class="section">
        <h2>Financial Reports</h2>
        
        <!-- Report Generation -->
        <div class="card">
          <h3>Generate Comprehensive Report</h3>
          <div class="form-row">
            <label>Start Date <input type="date" id="reportStart" /></label>
            <label>End Date <input type="date" id="reportEnd" /></label>
            <button class="btn primary" id="btnGenReport">üìä Generate PDF Report</button>
          </div>
          <div class="report-features">
            <h4>Report Includes:</h4>
            <div class="grid-2">
              <div>
                <h5>üìà Financial Analysis</h5>
                <ul>
                  <li>Executive Summary with Health Score</li>
                  <li>Income vs Expenses Analysis</li>
                  <li>Spending Patterns by Day/Category</li>
                  <li>Budget vs Actual Performance</li>
                </ul>
              </div>
              <div>
                <h5>üí∞ Advanced Insights</h5>
                <ul>
                  <li>Cash Flow Analysis by Account</li>
                  <li>Net Worth Trends & Changes</li>
                  <li>Credit Card Utilization & Payments</li>
                  <li>Personalized Recommendations</li>
                </ul>
              </div>
            </div>
          </div>
        </div>

        <!-- Quick Stats Preview -->
        <div class="card">
          <h3>Quick Financial Overview</h3>
          <div class="grid-3" id="quickStats">
            <div class="stat-card">
              <div class="stat-title">This Month's Income</div>
              <div class="stat-value" id="quickIncome">‚Äî</div>
            </div>
            <div class="stat-card">
              <div class="stat-title">This Month's Expenses</div>
              <div class="stat-value" id="quickExpenses">‚Äî</div>
            </div>
            <div class="stat-card">
              <div class="stat-title">Net Income</div>
              <div class="stat-value" id="quickNet">‚Äî</div>
            </div>
          </div>
        </div>

        <!-- PDF Report Structure -->
        <div id="report" style="display: none;">
          <header id="report-header" class="section">
            <h1>Personal Finance Report</h1>
            <div class="meta">
              <span id="report-period">Period: ‚Äî</span><br>
              <span id="report-generated">Generated: ‚Äî</span>
            </div>
          </header>

          <section id="exec-summary" class="section">
            <h2>Executive Summary</h2>
            <div class="kpis" id="kpi-grid"></div>
          </section>

          <section id="spending" class="section">
            <h2>Spending Patterns</h2>
            <div class="block" id="daily-spending"></div>
          </section>

          <section id="income-expenses" class="section">
            <h2>Income vs Expenses</h2>
            <div class="block" id="income-by-category"></div>
            <div class="block" id="top-expense-categories"></div>
          </section>

          <section id="accounts" class="section">
            <h2>Account Activity</h2>
            <div class="block" id="account-activity"></div>
          </section>

          <section id="budget" class="section">
            <h2>Budget vs Actual</h2>
            <div class="block" id="budget-vs-actual"></div>
          </section>

          <section id="cashflow" class="section">
            <h2>Cash Flow</h2>
            <div class="block" id="cashflow-summary"></div>
          </section>
        </div>
      </section>
    </template>

  <template id="tpl-settings">
    <section class="section">
      <h2>Settings</h2>
      <div class="card grid-2">
        <label>Base Currency (locked)<input value="USD" disabled /></label>
        <label>Fiscal Month Start Day<input type="number" id="setFiscalStart" min="1" max="28" value="1"/></label>
        <label>Default Transaction Date
          <select id="setDefaultTxnDate"><option value="today">Today</option><option value="selected">Remember last selected</option></select>
        </label>
        <label>Manual FX (USD per 1 MXN)<input type="number" id="setManualFX" step="0.0001" placeholder="e.g., 0.0550"/></label>
        <label>Use Manual FX Override<select id="setUseManualFX"><option value="false">No</option><option value="true">Yes</option></select></label>
        <div class="row gap-sm">
          <button class="btn" id="btnFetchFX">Fetch Today's FX</button>
          <button class="btn primary" id="btnSaveSettings">Save</button>
        </div>
      </div>
      
      <!-- Enhanced FX Rate API Configuration -->
      <div class="card" style="margin-top: 1rem;">
        <h3>üåç FX Rate API Configuration</h3>
        <div class="form-help">
          <p class="small muted">Configure external APIs for more accurate exchange rates. Free APIs work without keys, premium APIs provide better rates and higher limits.</p>
        </div>
        
        <div class="grid-2">
          <label>ExchangeRatesAPI.io Key <input id="exchangeratesApiKey" type="password" placeholder="Get free key at exchangeratesapi.io" /></label>
          <label>Fixer.io API Key <input id="fixerApiKey" type="password" placeholder="Get free key at fixer.io" /></label>
          <label>CurrencyAPI Key <input id="currencyApiKey" type="password" placeholder="Get free key at currencyapi.com" /></label>
          <label>ExchangeRate-API Key <input id="exchangeRateApiKey" type="password" placeholder="Optional - free tier available" /></label>
          <label>Alpha Vantage Key <input id="alphaVantageKey" type="password" placeholder="Get free key at alphavantage.co" /></label>
        </div>
        
        <div class="form-help">
          <p class="small muted">
            <strong>Recommended:</strong> ExchangeRatesAPI.io (100/month free, CORS-enabled, accurate historical data)<br>
            <strong>Free APIs:</strong> ExchangeRate-API (1500/month), ExchangeRate-Host (unlimited)<br>
            <strong>Premium APIs:</strong> Fixer.io (100/month free), CurrencyAPI (300/month free), Alpha Vantage (25/day free)
          </p>
        </div>
        
        <div class="row gap-sm">
          <button class="btn" id="testFxApis">Test FX APIs</button>
          <button class="btn" id="testHistoricalRates">Test Historical Rates</button>
          <button class="btn" id="clearApiKeys">Clear All Keys</button>
        </div>
      </div>
      <div class="card grid-2">
        <div>
          <h3>Data Backup</h3>
          <button class="btn" id="btnExportExcel">Export All Data</button>
          <input type="file" id="fileImportExcel" accept=".xlsx" class="hidden" />
          <button class="btn" id="btnImportExcel">Import Data</button>
          <p class="small muted">Import overwrites all local data.</p>
        </div>
        <div class="danger-zone">
          <h3>Danger Zone</h3>
          <button class="btn danger" id="btnWipeAll">Clear ALL Data</button>
        </div>
      </div>
      <div class="card">
        <h3>Category Management</h3>
        <button class="btn" id="btnManageCategories">Open Categories</button>
      </div>
    </section>
  </template>
<div style="position:fixed;right:10px;bottom:10px;padding:8px 12px;background:#111;color:#fff;font-size:12px;border-radius:6px;z-index:99999;">
  DEV PREVIEW ‚Äî build <span id="build-ts"></span>
  <script>document.getElementById('build-ts').textContent=new Date().toISOString();</script>
</div>

</body>
</html>
