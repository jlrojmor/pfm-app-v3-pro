<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comprehensive Debug Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .btn {
            background: #007AFF;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 8px 8px 8px 0;
        }
        .btn:hover {
            background: #0056b3;
        }
        .status {
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            margin: 5px 0;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            border-left: 4px solid #007AFF;
        }
        .test-result.pass {
            border-left-color: #28a745;
            background: #d4edda;
        }
        .test-result.fail {
            border-left-color: #dc3545;
            background: #f8d7da;
        }
        .console-output {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Comprehensive Debug Test</h1>
        <p>Testing every component to identify what's working and what's not.</p>
        
        <button class="btn" onclick="runAllTests()">üöÄ Run All Tests</button>
        <button class="btn" onclick="clearResults()">üßπ Clear Results</button>
        
        <div id="testResults"></div>
        <div id="consoleOutput"></div>
    </div>

    <!-- Load required scripts in the same order as main app -->
    <script src="js/cards-convergent-v2-integration.js?v=1.0"></script>
    <script src="js/simple-cards-convergent.js"></script>
    <script src="js/statement-ingestion-wrapper.js"></script>
    <script src="js/ui.js?v=3.9"></script>

    <script>
        let testResults = [];
        let consoleLogs = [];
        
        // Capture console logs
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        
        console.log = function(...args) {
            consoleLogs.push(`LOG: ${args.join(' ')}`);
            originalLog.apply(console, args);
        };
        
        console.error = function(...args) {
            consoleLogs.push(`ERROR: ${args.join(' ')}`);
            originalError.apply(console, args);
        };
        
        console.warn = function(...args) {
            consoleLogs.push(`WARN: ${args.join(' ')}`);
            originalWarn.apply(console, args);
        };
        
        function addTestResult(testName, passed, details) {
            testResults.push({
                name: testName,
                passed: passed,
                details: details,
                timestamp: new Date().toLocaleTimeString()
            });
            updateResultsDisplay();
        }
        
        function updateResultsDisplay() {
            const resultsDiv = document.getElementById('testResults');
            const consoleDiv = document.getElementById('consoleOutput');
            
            let html = '<h2>üß™ Test Results:</h2>';
            
            testResults.forEach(result => {
                const statusClass = result.passed ? 'pass' : 'fail';
                const icon = result.passed ? '‚úÖ' : '‚ùå';
                html += `
                    <div class="test-result ${statusClass}">
                        <strong>${icon} ${result.name}</strong> (${result.timestamp})
                        <div style="font-size: 12px; margin-top: 5px;">${result.details}</div>
                    </div>
                `;
            });
            
            // Summary
            const passed = testResults.filter(r => r.passed).length;
            const total = testResults.length;
            const percentage = total > 0 ? (passed / total * 100).toFixed(1) : 0;
            
            html += `
                <div class="test-result ${passed === total ? 'pass' : 'fail'}">
                    <strong>üìä Summary: ${passed}/${total} tests passed (${percentage}%)</strong>
                </div>
            `;
            
            resultsDiv.innerHTML = html;
            
            // Console output
            consoleDiv.innerHTML = `
                <h3>üìù Console Output:</h3>
                <div class="console-output">${consoleLogs.slice(-20).join('<br>')}</div>
            `;
        }
        
        function clearResults() {
            testResults = [];
            consoleLogs = [];
            updateResultsDisplay();
        }
        
        async function runAllTests() {
            clearResults();
            
            // Test 1: Check if all required objects exist
            testObjectAvailability();
            
            // Test 2: Check Cards Convergent V2 functionality
            testCardsConvergentV2();
            
            // Test 3: Check Quick Setup functionality
            testQuickSetup();
            
            // Test 4: Check PDF Upload functionality
            testPdfUpload();
            
            // Test 5: Check Statement Ingestion
            testStatementIngestion();
            
            // Test 6: Check UI Functions
            testUIFunctions();
            
            // Test 7: Integration Test
            testIntegration();
        }
        
        function testObjectAvailability() {
            const objects = [
                { name: 'window.CardsConvergentV2', obj: window.CardsConvergentV2 },
                { name: 'window.SimpleCardsConvergent', obj: window.SimpleCardsConvergent },
                { name: 'window.StatementIngestionWrapper', obj: window.StatementIngestionWrapper },
                { name: 'window.quickSetupCC', obj: window.quickSetupCC },
                { name: 'window.uploadStatement', obj: window.uploadStatement },
                { name: 'window.parseSummaryText', obj: window.parseSummaryText }
            ];
            
            let passed = 0;
            let details = '';
            
            objects.forEach(obj => {
                const exists = typeof obj.obj !== 'undefined';
                if (exists) passed++;
                details += `${obj.name}: ${exists ? '‚úÖ' : '‚ùå'} `;
            });
            
            addTestResult(
                'Object Availability',
                passed === objects.length,
                `${passed}/${objects.length} objects available. ${details}`
            );
        }
        
        function testCardsConvergentV2() {
            try {
                if (typeof window.CardsConvergentV2 === 'undefined') {
                    addTestResult('Cards Convergent V2', false, 'CardsConvergentV2 object not available');
                    return;
                }
                
                // Test getStatus method
                const status = window.CardsConvergentV2.getStatus();
                const hasStatus = status && status.enabled && status.version;
                
                // Test processQuickSummary method
                let summaryWorks = false;
                try {
                    const result = window.CardsConvergentV2.processQuickSummary("Test $100", "test-card");
                    summaryWorks = result && typeof result.confidence === 'number';
                } catch (e) {
                    summaryWorks = false;
                }
                
                addTestResult(
                    'Cards Convergent V2',
                    hasStatus && summaryWorks,
                    `Status: ${hasStatus ? '‚úÖ' : '‚ùå'}, Summary: ${summaryWorks ? '‚úÖ' : '‚ùå'}`
                );
                
            } catch (error) {
                addTestResult('Cards Convergent V2', false, `Error: ${error.message}`);
            }
        }
        
        function testQuickSetup() {
            try {
                if (typeof window.quickSetupCC === 'undefined') {
                    addTestResult('Quick Setup', false, 'quickSetupCC function not available');
                    return;
                }
                
                // Test if function can be called (it should handle missing account gracefully)
                let canCall = false;
                try {
                    window.quickSetupCC('non-existent-card');
                    canCall = true; // If it doesn't throw, it's working
                } catch (e) {
                    canCall = e.message.includes('Credit card account not found'); // Expected error
                }
                
                addTestResult(
                    'Quick Setup',
                    canCall,
                    canCall ? 'Function can be called' : 'Function throws unexpected error'
                );
                
            } catch (error) {
                addTestResult('Quick Setup', false, `Error: ${error.message}`);
            }
        }
        
        function testPdfUpload() {
            try {
                if (typeof window.uploadStatement === 'undefined') {
                    addTestResult('PDF Upload', false, 'uploadStatement function not available');
                    return;
                }
                
                // Test if function can be called
                let canCall = false;
                try {
                    window.uploadStatement('test-card');
                    canCall = true; // If it doesn't throw, it's working
                } catch (e) {
                    canCall = e.message.includes('File input not found'); // Expected error
                }
                
                addTestResult(
                    'PDF Upload',
                    canCall,
                    canCall ? 'Function can be called' : 'Function throws unexpected error'
                );
                
            } catch (error) {
                addTestResult('PDF Upload', false, `Error: ${error.message}`);
            }
        }
        
        function testStatementIngestion() {
            try {
                if (typeof window.StatementIngestionWrapper === 'undefined') {
                    addTestResult('Statement Ingestion', false, 'StatementIngestionWrapper not available');
                    return;
                }
                
                const hasIngestMethod = typeof window.StatementIngestionWrapper.ingestStatement === 'function';
                
                addTestResult(
                    'Statement Ingestion',
                    hasIngestMethod,
                    hasIngestMethod ? 'ingestStatement method available' : 'ingestStatement method missing'
                );
                
            } catch (error) {
                addTestResult('Statement Ingestion', false, `Error: ${error.message}`);
            }
        }
        
        function testUIFunctions() {
            try {
                const functions = [
                    'window.confirmCycleValidation',
                    'window.editCycleDates',
                    'window.parseSummaryText'
                ];
                
                let available = 0;
                let details = '';
                
                functions.forEach(funcName => {
                    const exists = typeof eval(funcName) !== 'undefined';
                    if (exists) available++;
                    details += `${funcName}: ${exists ? '‚úÖ' : '‚ùå'} `;
                });
                
                addTestResult(
                    'UI Functions',
                    available === functions.length,
                    `${available}/${functions.length} functions available. ${details}`
                );
                
            } catch (error) {
                addTestResult('UI Functions', false, `Error: ${error.message}`);
            }
        }
        
        function testIntegration() {
            try {
                // Test if Cards Convergent V2 can work with other components
                if (typeof window.CardsConvergentV2 === 'undefined') {
                    addTestResult('Integration', false, 'CardsConvergentV2 not available for integration test');
                    return;
                }
                
                // Test truth merging
                const testCardId = 'integration-test-' + Date.now();
                let mergeWorks = false;
                try {
                    const merged = window.CardsConvergentV2.mergeTruth(testCardId);
                    mergeWorks = merged && typeof merged.cardId === 'string';
                } catch (e) {
                    mergeWorks = false;
                }
                
                // Test installment calculation
                let installmentWorks = false;
                try {
                    const result = window.CardsConvergentV2.calculateInstallmentPayments(testCardId, 100);
                    installmentWorks = result && typeof result.totalPayment === 'number';
                } catch (e) {
                    installmentWorks = false;
                }
                
                addTestResult(
                    'Integration',
                    mergeWorks && installmentWorks,
                    `Merge: ${mergeWorks ? '‚úÖ' : '‚ùå'}, Installments: ${installmentWorks ? '‚úÖ' : '‚ùå'}`
                );
                
            } catch (error) {
                addTestResult('Integration', false, `Error: ${error.message}`);
            }
        }
        
        // Initialize
        window.addEventListener('load', function() {
            console.log('üöÄ Comprehensive Debug Test loaded');
            runAllTests();
        });
    </script>
</body>
</html>





